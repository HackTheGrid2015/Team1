// This example creates a simple polygon representing the Bermuda Triangle.
// When the user clicks on the polygon an info window opens, showing
// information about the polygon's coordinates.
//var xmlhttp = new XMLHttpRequest();
//var url = "output.txt";
//var myArr;
//
//xmlhttp.onreadystatechange = function() {
//  if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
//    myArr = JSON.parse(xmlhttp.responseText);
//
//  }
//}
//xmlhttp.open("GET", url, true);
//xmlhttp.send();
//  var locations = [
//        [35.7152287452982,-84.0553062790687],
//        [40.911649380533,-75.2724040351245],
//        [42.503179915146,-77.6019768964572],
//        [41.3994524304109,-76.7059644486769],
//        [36.2004839164587,-119.525147157497],
//        [-32.8029070060745,115.690276160607],
//        [35.3597553487997,-85.8752499529106],
//        [35.2566164104414,-84.3311694674291],
//        [35.7497445481521,-84.6374465991225],
//        [40.7707728785949,-81.5415012675186],
//    [-34.245814691393,117.458689556186],
//    [39.8639718258909,-84.7504304164195],
//    [34.7392425949227,-86.3176003436557],
//    [37.7001170850976,-86.7125427898487],
//    [35.6088335933777,-84.3272516107781],
//    [39.2544666451289,-77.3445139282871],
//    [39.4946117342326,-76.2369973358117],
//    [33.4279610296327,-87.739802714388],
//    [26.7876308571595,-85.9533710286429],
//    [39.4135053186884,-76.6735134478373],
//    [36.9747773634418,-76.1407934085129],
//    [37.015493125438,-78.6007400577334],
//    [40.8320996694784,-84.1738940211641],
//    [40.8701537591995,-75.3945508585017],
//    [41.1315396276158,-75.3231599236468],
//    [34.6594697995729,-119.228693326732],
//    [41.3424881002449,-79.9866752349117],
//    [41.8711465753156,-80.9844199897345],
//    [34.0906904887998,-111.372305777857],
//    [40.8277502328018,-79.458524691614],
//    [33.9358425723689,-89.7146783072749],
//    [35.3048955466476,-90.6199340656638],
//    [34.3397950458898,-89.7742065968058],
//    [41.631233505008,-87.3260213145197],
//    [42.6154239547021,-87.9129693549113],
//    [39.6674824890135,-84.6953540070693],
//    [39.8993499238525,-76.8759924946197],
//    [45.5301813730755,-77.396295546062],
//    [41.3617632682781,-81.855845144153],
//    [36.9429240987602,-80.1517343013829],
//    [39.9755745880134,-75.8153796944874],
//    [32.6368920489224,-111.743761115474],
//    [-31.2919765300402,115.846805245816],
//    [36.413185171704,-86.5710632582286],
//    [39.0173024217605,-77.5476655557989],
//    [42.6403420591367,-88.3382343719318],
//    [33.9155999958007,-86.3974543325868],
//    [40.9465603126708,-89.2386869453061],
//    [35.5075500441597,-86.5665740691473],
//    [56.3611152820036,-89.2480913668134],
//    [41.9871842736702,-83.1061504113129],
//    [38.9045253329195,-83.1686420800565],
//    [38.946668750977,-117.915616287794],
//    [42.8035070151167,-82.9267250585322],
//    [39.9496539004493,-82.362882294985],
//    [37.6360457338999,-77.4347679635995],
//    [41.2591029869385,-81.2819635553541],
//    [40.9629107329812,-82.0837216505019],
//    [39.5147758619085,-77.4919942216672],
//    [-32.0366907935717,115.624852657255],
//    [24.6695148954993,-86.1655572676986],
//    [37.1334160054275,-83.1631129572274],
//    [37.0925086459878,-86.3384432425338],
//    [35.3826995961546,-76.8944885666696],
//    [40.1212458178399,-76.8027902490166],
//    [38.8047182194686,-76.9497941168284],
//    [40.6547571821189,-76.3616716149569],
//    [34.4260629050407,-87.1288734467559],
//    [36.5438929333868,-81.8142740326866],
//    [-31.9382542259649,115.640890596498],
//    [39.6052668261916,-74.530013462068],
//    [39.48982974602,-77.5352349702706],
//    [37.3795685516952,-86.7862110024142],
//    [40.0704481528192,-75.3286476407701],
//    [39.1773463877146,-75.2088474661608],
//    [39.5343144209652,-75.7234051300189],
//    [39.1979690599666,-76.2733777765576],
//    [42.5160658361229,-76.6009389911411],
//    [39.5711607508125,-75.5317843492105],
//    [36.2654186794405,-76.538428765943],
//    [36.6630080535452,-77.1433641612383],
//    [39.9015335049277,-75.3309065609152],
//    [40.0337427865892,-75.9602074733592],
//    [36.090811013943,-88.0946298207333],
//    [40.3923399893026,-75.9955032608119],
//    [38.536209351667,-77.0135380263029],
//    [-31.9441062042139,115.969904495963],
//    [34.306850267603,-117.953147362972],
//    [43.1907716904283,-74.5126117686909],
//    [35.3271409781764,-86.4968470238091],
//    [35.4100513758499,-87.1980995770593],
//    [37.4107798293847,-87.9729992529587],
//    [29.9144063616552,-86.9057091421836],
//    [27.8982718639413,-86.5204442665147],
//    [-31.3601879371609,116.419292619743],
//    [35.4649314240373,-86.4402948151126],
//    [32.8583867970472,-110.452509869418],
//    [-32.535737099883,115.46596241126],
//    [33.2240766212148,-112.212285765074],
//    [35.8169298294632,-86.6255593021976],
//    [34.7303778381148,-84.5716045448668],
//    [41.3126324907673,-83.4251272382717],
//    [38.367456241898,-75.3973839199018],
//    [40.8056121278092,-75.3047564137213],
//    [36.9835599365034,-86.2095514858663],
//    [32.0237562611227,-86.7964289604034],
//    [34.4558046103087,-85.9083207297225],
//    [39.7645049610547,-76.4356294929825],
//    [41.3583593758561,-88.6436942004062],
//    [38.0911073885643,-75.79234434573],
//    [40.975599598047,-75.1534670196082],
//    [40.0663827220982,-77.7204043649709],
//    [40.7668157250687,-75.6303616963361],
//    [38.3841078672406,-78.6610766494962],
//    [40.5248521240685,-76.0978630567791],
//    [34.0392008268324,-111.755598980957],
//    [33.9318321378806,-117.791491435473],
//    [36.4872241408489,-87.2888538044976],
//    [35.4075926000769,-84.5287577439569],
//    [-31.863200686971,116.073518316146],
//    [41.4656289355583,-87.4115715083778],
//    [37.5865129731283,-118.017646152991],
//    [39.14973846159,-76.5380274939083],
//    [31.062121019809,-117.810761809312],
//    [39.0881036668354,-75.7630485853005],
//    [40.2777983237288,-74.9685624257136],
//    [40.5791521325239,-74.8902328073693],
//    [40.5958198512043,-75.6975897365501],
//    [39.4624171284226,-75.5110621444379],
//    [39.5029506357813,-74.5955474380912],
//    [38.4909923214284,-76.0129652942446],
//    [39.6239148995483,-74.8214631630944],
//    [39.4929711061764,-75.5183035900775],
//    [40.3063634183816,-74.8872424788435],
//    [34.5153328052849,-80.4717906615481],
//    [41.5466427556703,-80.5402223646023]
//    [38.8552375739928,-77.5002746182583],
//    [40.8523128700756,-75.823433154618],
//    [40.1159919098222,-74.4841155324422],
//    [40.437290615696,-76.1540637103495],
//    [39.255906598637,-75.9148799956434],
//    [41.5652634239697,-76.5756889758828],
//    [40.0158779791966,-76.2251586017342],
//    [40.219341931234,-76.4361159497161],
//    [39.8327538676168,-78.5090357488807],
//    [38.7811759254661,-77.4488323275664],
//    [38.9071614995607,-76.455798338244],
//    [100.972478438574,-77.4702450973968],
//    [40.9264690791682,-82.0553242599841],
//    [41.6948058275431,-82.0762665200016],
//    [39.8053177475921,-84.1102121134306],
//    [34.5163171841368,-86.9893818313713],
//    [34.2658358855425,-85.8154646290416],
//    [38.3334690127648,-107.950815669881],
//    [43.8876044058724,-74.4292868007785],
//    [33.8075891855669,-90.139467657885],
//    [39.4552937880462,-77.018192815272],
//    [36.1664849698191,-90.4410486567612],
//    [35.2288185023393,-90.6352905557785],
//    [33.6297089455471,-89.2950913346421],
//    [38.3689331863689,-105.161948637403],
//    [32.9595163693151,-117.223097815648],
//    [34.9242288751662,-118.37321471982],
//    [37.9316418474176,-117.539979980583],
//    [31.8138920220215,-117.981742781048],
//    [34.3039135315817,-118.415294461082],
//    [40.3698854864484,-82.0495030488269],
//    [39.8237201030734,-80.6085178365675],
//    [40.5971687723938,-83.7955069933922],
//    [32.1708248311384,-112.178513021892],
//    [41.7496111929111,-87.9378531419752],
//    [33.6678037380343,-111.237179907307],
//    [41.804928292122,-87.9913743947053],
//    [38.0851124376241,-75.678367198296],
//    [32.0093211480038,-112.158740061751],
//    [42.4555538652889,-76.3576986152135],
//    [40.6332767133039,-105.294152413927],
//    [38.0158966727166,-79.411473656663],
//    [41.4455640018594,-76.4110764106131],
//    [42.917055572253,-88.2366038648774],
//    [41.892224762094,-88.2542664899166],
//    [38.4904890248445,-79.9845393272552],
//    [48.7715824981485,-76.9870961230159],
//    [32.5643374768049,-111.579788346596],
//    [32.9352966328927,-112.211437359661],
//    [37.9962591054193,-75.8549717964649],
//    [38.5850529327168,-77.7365100297786],
//    [38.8519730703512,-77.1753567517579],
//    [38.3561848281317,-77.8034714901668],
//    [35.9763854232769,-76.4538624268377],
//    [35.4733018303184,-89.3784725544725],
//    [34.262529574151,-89.4324249362089],
//    [35.7604504258032,-90.536107019951],
//    [35.0611873343806,-89.2016484870937],
//    [39.1981046224119,-104.606416044476],
//    [34.5941235007868,-87.6136131664954],
//    [36.2073495588437,-108.000604152948],
//    [37.4216653360098,-76.2413072223507],
//    [32.9220874439491,-111.492045733422],
//    [38.9768515723595,-75.5741458693736],
//    [41.3775693607647,-77.6612693138259],
//    [40.4004337115769,-79.1878824074339],
//    [38.0838580507548,-77.5719474708803],
//    [41.1801875853267,-75.744928719517],
//    [42.1345441562744,-76.7346519144591],
//    [27.2085108388372,-83.1552553394032],
//    [42.12284045554,-78.4576309380884],
//    [40.838319854789,-75.3968581322205],
//    [37.5454382524133,-86.994163297226],
//    [41.7503054696676,-79.2970619934643],
//    [41.845498355396,-74.3774823369638],
//    [40.8422651483998,-78.7447259997607],
//    [41.0116987447644,-79.0041604588386],
//    [39.7844527176196,-74.3505343389717],
//    [42.8968259603904,-77.2841100322516],
//    [34.4841575156798,-89.7927025094862],
//    [41.9917723767335,-88.2161682446812],
//    [39.4183515362883,-76.5662342548703],
//    [32.8915347948544,-117.614625638253],
//    [35.2325713246644,-118.206297619781],
//    [34.38607400983,-117.873473881824],
//    [34.1473712644536,-117.88421319958],
//    [27.2008555235616,-117.88559228375],
//    [22.7114930515349,-117.625521781519],
//    [33.3572938816532,-117.972602089486],
//    [34.6226910450655,-117.545582649356],
//    [32.7041780370816,-117.868979975667],
//    [34.5537928551438,-116.583867755904],
//    [39.9672771407618,-76.0814317144699],
//    [30.9468187740679,-76.7626287150991],
//    [40.1155415086257,-76.5910171629001],
//    [39.6117357308087,-74.2996587515189],
//    [39.1331555451275,-77.1970075624592],
//    [38.0688368145505,-77.2964825763297],
//    [42.0888125831881,-77.4408173879647],
//    [38.8761338900362,-76.0251426418241],
//    [33.1996957368165,-118.05167940054],
//    [32.986892848312,-117.826725655454],
//    [34.2210135211386,-117.120016337013],
//    [33.7435677618662,-117.0794215486],
//    [32.5481742593283,-117.495977690194],
//    [34.5855365224578,-118.179217909515],
//    [39.2732325206819,-75.9008253552128],
//    [40.0169510661827,-74.8002849335559],
//    [40.7797992859548,-75.9410544949527],
//    [40.761741837393,-74.0353909154695],
//    [28.1852636668824,-81.8013404557804]
//
//  ];
  var infolist = new Array();
  var key_ne = new Array();
  for(var i=0; i<keylist.length; i++){
    var thekey=keylist[i];
    if(myArr[thekey].length==366) {
      var theinfo = myArr[thekey][365];
      infolist.push(theinfo);
      key_ne.push(thekey);
    }
}
  var longlatlist = new Array();
  for(var i=0; i<infolist.length; i++){
    var theinfo = infolist[i];
    var longtitude =parseFloat(theinfo[0]);
    var latitude = parseFloat(theinfo[1]);
    var pair = new Array();
    pair.push(longtitude);
    pair.push(latitude);
    longlatlist.push(pair);
  }


  var red = 'img/red.png';
  var orange='img/orange.png';
  var yellow ='img/yellow.png';
  var green = 'img/green.png';
  var light = 'img/light.png';
  var dark = 'img/dark.png';
  var icons = [
        red,
        orange,
        yellow,
        green,
        light,
        dark
  ]

  var colorlist= ["green","blue","purple","orange"];
var markers = new Array();  

var map;
var infoWindow;
var clickedList = new Array();
var numofplaceschosen = 0;

function contains(a, obj){
  for(var i=0; i< a.length; i++){
    if(a[i]==obj){
      return true;
    }
  }
  return false;
}

function initMap() {

    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 3,
        center: {lat: 38.425646, lng: -99.944614},
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        mapTypeControl: false,
        streetViewControl: false,
        panControl: false,
        zoomControlOptions: {
            position: google.maps.ControlPosition.LEFT_BOTTOM
        }
    });

    // Define the LatLng coordinates for the polygon.

    for (var i = 0; i < infolist.length; i++) {
        var marker = new google.maps.Marker({
            position: new google.maps.LatLng(longlatlist[i][0], longlatlist[i][1]),
            map: map,
            //key: myArr[i][0],
            icon: icons[i % 6],
            industry: infolist[i][2],
            subindustry: infolist[i][3],
            timezone: infolist[i][4],
            key: key_ne[i]
        });

        markers.push(marker);
    }

    for (var i = 0; i < markers.length; i++) {
        var marker = markers[i];
        addMarker(marker);
    }
    autoCenter();
}

  function autoCenter(){
    var bounds = new google.maps.LatLngBounds();
    for(var i=0; i<markers.length;i++){
      bounds.extend(markers[i].position);
    }
    map.fitBounds(bounds);
  }

  function addMarker(marker){
      marker.setMap(map);
      var siteid = marker.key;
      range_el.addEventListener('input', function(){
      //var year = parseInt(yy);
      //var month =parseInt(mm);
      //var day = parseInt(dd);
      //var datechosen = new Date(year,month-1,day);
      //var startdate = new Date(2014,0,1);
      //var daysdiff = Math.floor((datechosen-startdate)/(60*60*24*1000));
      //var daysdiff = calnumdays(year,month,day);
      var daysdiff= Math.floor(parseFloat(this.value)/100*364);
      var valu = myArr[siteid][daysdiff][1];
      marker.setOptions({icon: icons[dealwithvalue(valu)]});
      marker.setMap(map);
    },false);
      marker.addListener('click', function(){
        if(!contains(clickedList, this)){
          clickedList.push(this);
        }
        else{
          var index = clickedList.indexOf(this);
          if(index>-1){
            clickedList.splice(index,1);
          }
        }

        var lat = this.getPosition().lat().toFixed(4);
        var lng = this.getPosition().lng().toFixed(4);
        var industry = this.industry;
        var subindustry = this.subindustry;
        var timezone = this.timezone;
        if(contains(clickedList, this)) {
          var dialog = document.createElement('div');
          dialog.id = "overlay";
          var header = document.createElement('header');
          var headertext = document.createTextNode('Lat: ' + lat + ', Lng: ' + lng);
    //var button = document.createElement('button');
    //var buttontext = document.createTextNode('Ok');
    //button.appendChild(buttontext);
          header.appendChild(headertext);
    //header.appendChild(button);
          var chartcolor = colorlist[numofplaceschosen];

          var section = document.createElement('section');
          var p4 = document.createElement('p');
          var p4text = document.createTextNode("Chart Colour: "+chartcolor);
          p4.appendChild(p4text);
          section.appendChild(p4);
          var p1 = document.createElement('p');
          var p1text = document.createTextNode("Industry: " + industry);
          p1.appendChild(p1text);
          section.appendChild(p1);
          var p2 = document.createElement('p');
          var p2text = document.createTextNode("Sub-Industry: " + subindustry);
          p2.appendChild(p2text);
          section.appendChild(p2);
          var p3 = document.createElement('p');
          var p3text = document.createTextNode("Time Zone: " + timezone);
          var button = document.createElement('button');
          var buttontext = document.createTextNode('Ok');
          button.appendChild(buttontext);
          p3.appendChild(p3text);
          p3.appendChild(button);
          section.appendChild(p3);

          var script = document.createElement('script');
          script.src = "box.js";

          dialog.appendChild(header);
          dialog.appendChild(section);
          document.getElementById("info-real-pan").appendChild(dialog);
          document.getElementById("info-real-pan").appendChild(script);

          numofplaceschosen++;
        }
      });
  }

function calnumdays(y,m,d){
  var start = new Date(2014,0,1);
  var chosen = new Date(y,m-1,d);
  var diff = Math.floor((chosen-start)/(60*60*24*1000));
  return diff;
}

function dealwithvalue(val){
  if(val<20){
    return 5;
  }
  else if(val<40){
    return 4;
  }
  else if(val<60){
    return 3;
  }
  else if(val<80){
    return 2;
  }
  else if(val<100){
    return 1;
  }
  else{
    return 0;
  }
}
